import{e as R,l as Y,b as z,f as A}from"./auth-C0PzaMq8.js";const P="http://localhost:8000",C="stockflow_admin_layout_v2",g=20,u=14,B=R(["admin"]);if(!B)throw new Error("Sessao invalida");document.getElementById("user-id").textContent=B.userId;document.getElementById("navbar-user-name").textContent="Admin";const s=document.getElementById("warehouse-canvas"),a=s.getContext("2d"),x=document.getElementById("sections-list"),h=document.getElementById("assigned-products"),I=document.getElementById("status-message"),X=document.getElementById("section-name"),_=document.getElementById("section-shelf"),D=document.getElementById("section-type"),H=document.getElementById("section-color"),w=document.getElementById("product-name"),S=document.getElementById("product-code"),L=document.getElementById("mode-draw"),k=document.getElementById("mode-select"),O=document.getElementById("add-product"),U=document.getElementById("delete-section"),W=document.getElementById("clear-layout"),J=document.getElementById("sync-api"),F=document.getElementById("logout-btn"),o={mode:"draw",sections:[],selectedId:null,draft:null,interaction:null};function i(e,t=!1){I.textContent=e,I.style.color=t?"#b30021":"#4f4f4f"}function $(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function E(){return o.sections.find(e=>e.id===o.selectedId)||null}function m(){localStorage.setItem(C,JSON.stringify(o.sections))}function G(e){return{...e,products:Array.isArray(e.products)?e.products:[]}}function Z(){try{const e=localStorage.getItem(C),t=e?JSON.parse(e):[];o.sections=t.map(G)}catch{o.sections=[]}}function v(e){o.mode=e,L.classList.toggle("active",e==="draw"),k.classList.toggle("active",e==="select"),s.style.cursor=e==="draw"?"crosshair":"default"}function j(){a.clearRect(0,0,s.width,s.height)}function q(){a.save(),a.strokeStyle="rgba(40, 62, 136, 0.10)",a.lineWidth=1;for(let t=0;t<=s.width;t+=40)a.beginPath(),a.moveTo(t,0),a.lineTo(t,s.height),a.stroke();for(let t=0;t<=s.height;t+=40)a.beginPath(),a.moveTo(0,t),a.lineTo(s.width,t),a.stroke();a.restore()}function K(e){a.save(),a.fillStyle="#0f2cff",a.fillRect(e.x+e.w-u,e.y+e.h-u,u,u),a.restore()}function Q(e,t=!1){a.save(),a.fillStyle=`${e.color}55`,a.strokeStyle=t?"#0f2cff":e.color,a.lineWidth=t?3:2,a.fillRect(e.x,e.y,e.w,e.h),a.strokeRect(e.x,e.y,e.w,e.h),a.fillStyle="#101010",a.font="bold 14px Segoe UI",a.fillText(e.name,e.x+8,e.y+18),a.font="12px Segoe UI",a.fillText(`Prateleira: ${e.shelf||"-"}`,e.x+8,e.y+34),a.fillText(`Tipo: ${e.type}`,e.x+8,e.y+50),a.fillText(`Produtos: ${e.products.length}`,e.x+8,e.y+66),t&&o.mode==="select"&&K(e),a.restore()}function V(){if(!o.draft)return;const{x:e,y:t,w:n,h:c}=N(o.draft);a.save(),a.fillStyle="rgba(15, 44, 255, 0.12)",a.strokeStyle="#0f2cff",a.setLineDash([8,6]),a.lineWidth=2,a.fillRect(e,t,n,c),a.strokeRect(e,t,n,c),a.restore()}function p(){j(),q();for(const e of o.sections)Q(e,e.id===o.selectedId);V()}function ee(){x.innerHTML="";for(const e of o.sections){const t=document.createElement("li");t.classList.toggle("active",e.id===o.selectedId);const n=document.createElement("div");n.className="section-meta";const c=document.createElement("span");c.className="section-name",c.textContent=e.name;const r=document.createElement("span");r.className="section-detail",r.textContent=`${e.type} | Prateleira ${e.shelf||"-"} | ${e.products.length} produto(s)`;const d=document.createElement("span");d.className="swatch",d.style.background=e.color,n.appendChild(c),n.appendChild(r),t.appendChild(n),t.appendChild(d),t.addEventListener("click",()=>{o.selectedId=e.id,l()}),x.appendChild(t)}}function te(){const e=E();if(h.innerHTML="",!e){const t=document.createElement("li");t.textContent="Selecione uma secao para vincular produtos.",h.appendChild(t);return}if(e.products.length===0){const t=document.createElement("li");t.textContent="Nenhum produto vinculado nesta secao.",h.appendChild(t);return}for(const t of e.products){const n=document.createElement("li"),c=document.createElement("div");c.className="product-meta";const r=document.createElement("span");r.className="product-name",r.textContent=t.name;const d=document.createElement("span");d.className="product-detail",d.textContent=t.code?`Codigo: ${t.code}`:"Sem codigo";const f=document.createElement("button");f.type="button",f.className="mini-danger",f.textContent="x",f.addEventListener("click",()=>{e.products=e.products.filter(b=>b.id!==t.id),m(),l(),i(`Produto removido da secao '${e.name}'.`)}),c.appendChild(r),c.appendChild(d),n.appendChild(c),n.appendChild(f),h.appendChild(n)}}function l(){ee(),te(),p()}function N(e){const t=Math.min(e.startX,e.endX),n=Math.min(e.startY,e.endY),c=Math.abs(e.endX-e.startX),r=Math.abs(e.endY-e.startY);return{x:t,y:n,w:c,h:r}}function M(e){const t=s.getBoundingClientRect(),n=s.width/t.width,c=s.height/t.height;return{x:(e.clientX-t.left)*n,y:(e.clientY-t.top)*c}}function y(e,t,n){return Math.max(t,Math.min(e,n))}function ne(e,t,n){return t>=e.x+e.w-u&&t<=e.x+e.w&&n>=e.y+e.h-u&&n<=e.y+e.h}function oe(e,t){for(let n=o.sections.length-1;n>=0;n-=1){const c=o.sections[n];if(e>=c.x&&e<=c.x+c.w&&t>=c.y&&t<=c.y+c.h)return c}return null}function ae(){const e=N(o.draft);if(e.w<g||e.h<g){i("Area muito pequena. Arraste uma area maior.",!0);return}const t=X.value.trim()||`Secao ${o.sections.length+1}`,n=_.value.trim(),c=D.value,r=H.value,d={id:$(),name:t,shelf:n,type:c,color:r,x:Math.round(e.x),y:Math.round(e.y),w:Math.round(e.w),h:Math.round(e.h),products:[]};o.sections.push(d),o.selectedId=d.id,m(),l(),i(`Secao '${t}' criada.`)}s.addEventListener("mousedown",e=>{const t=M(e),n=oe(t.x,t.y);if(o.mode==="select"){if(o.selectedId=n?n.id:null,!n){o.interaction=null,l();return}ne(n,t.x,t.y)?o.interaction={type:"resize",sectionId:n.id,startX:t.x,startY:t.y,initialW:n.w,initialH:n.h}:o.interaction={type:"move",sectionId:n.id,offsetX:t.x-n.x,offsetY:t.y-n.y},l();return}if(n){o.selectedId=n.id,l();return}o.draft={startX:t.x,startY:t.y,endX:t.x,endY:t.y}});s.addEventListener("mousemove",e=>{const t=M(e);if(o.draft){o.draft.endX=t.x,o.draft.endY=t.y,p();return}if(!o.interaction)return;const n=o.sections.find(c=>c.id===o.interaction.sectionId);if(n){if(o.interaction.type==="move"){n.x=y(t.x-o.interaction.offsetX,0,s.width-n.w),n.y=y(t.y-o.interaction.offsetY,0,s.height-n.h),p();return}if(o.interaction.type==="resize"){const c=t.x-o.interaction.startX,r=t.y-o.interaction.startY;n.w=y(Math.round(o.interaction.initialW+c),g,s.width-n.x),n.h=y(Math.round(o.interaction.initialH+r),g,s.height-n.y),p()}}});function T(){const e=!!o.draft,t=!!o.interaction;o.draft&&(ae(),o.draft=null),o.interaction&&(o.interaction=null,m(),l()),(e||t)&&p()}s.addEventListener("mouseup",T);s.addEventListener("mouseleave",T);L.addEventListener("click",()=>v("draw"));k.addEventListener("click",()=>v("select"));F.addEventListener("click",Y);O.addEventListener("click",()=>{const e=E();if(!e){i("Selecione uma secao antes de vincular produto.",!0);return}const t=w.value.trim(),n=S.value.trim();if(!t){i("Informe o nome do produto.",!0);return}e.products.push({id:$(),name:t,code:n}),w.value="",S.value="",m(),l(),i(`Produto vinculado na secao '${e.name}'.`)});U.addEventListener("click",()=>{const e=E();if(!e){i("Selecione uma secao para remover.",!0);return}o.sections=o.sections.filter(t=>t.id!==e.id),o.selectedId=null,m(),l(),i(`Secao '${e.name}' removida.`)});W.addEventListener("click",()=>{o.sections=[],o.selectedId=null,m(),l(),i("Planta limpa.")});J.addEventListener("click",async()=>{if(o.sections.length===0){i("Nada para sincronizar.",!0);return}const e=z();if(!e){i("Sem token de autenticacao.",!0);return}let t=0,n=0;for(const c of o.sections){const r={nome:c.name,pos_x:c.x,pos_y:c.y,largura:c.w,altura:c.h,cor_padrao:c.color};try{(await fetch(`${P}/secoes/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(r)})).ok?t+=1:n+=1}catch{n+=1}}i(`Sincronizacao finalizada. Sucesso: ${t}, Falhas: ${n}.`,n>0)});async function ce(){const e=document.getElementById("navbar-user-name");try{const t=await A();e.textContent=t.nome||"Admin"}catch{e.textContent="Admin"}}Z();v("draw");l();i("Pronto para desenhar e organizar a planta.");ce();
