import{e as I,l as B,a as k}from"./auth-CVND7qm_.js";const L="http://localhost:8000",g="stockflow_admin_layout_v1",m=20,p=I(["admin"]);if(!p)throw new Error("Sessao invalida");document.getElementById("user-id").textContent=p.userId;const c=document.getElementById("warehouse-canvas"),n=c.getContext("2d"),h=document.getElementById("sections-list"),y=document.getElementById("status-message"),C=document.getElementById("section-name"),T=document.getElementById("section-shelf"),$=document.getElementById("section-type"),M=document.getElementById("section-color"),E=document.getElementById("mode-draw"),w=document.getElementById("mode-select"),b=document.getElementById("clear-layout"),R=document.getElementById("sync-api"),N=document.getElementById("logout-btn"),o={mode:"draw",sections:[],selectedId:null,draft:null};function d(e,t=!1){y.textContent=e,y.style.color=t?"#b30021":"#4f4f4f"}function Y(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function v(){localStorage.setItem(g,JSON.stringify(o.sections))}function _(){try{const e=localStorage.getItem(g);o.sections=e?JSON.parse(e):[]}catch{o.sections=[]}}function f(e){o.mode=e,E.classList.toggle("active",e==="draw"),w.classList.toggle("active",e==="select")}function P(){n.clearRect(0,0,c.width,c.height)}function X(){n.save(),n.strokeStyle="rgba(40, 62, 136, 0.10)",n.lineWidth=1;for(let t=0;t<=c.width;t+=40)n.beginPath(),n.moveTo(t,0),n.lineTo(t,c.height),n.stroke();for(let t=0;t<=c.height;t+=40)n.beginPath(),n.moveTo(0,t),n.lineTo(c.width,t),n.stroke();n.restore()}function z(e,t=!1){n.save(),n.fillStyle=`${e.color}55`,n.strokeStyle=t?"#0f2cff":e.color,n.lineWidth=t?3:2,n.fillRect(e.x,e.y,e.w,e.h),n.strokeRect(e.x,e.y,e.w,e.h),n.fillStyle="#101010",n.font="bold 14px Segoe UI",n.fillText(e.name,e.x+8,e.y+18),n.font="12px Segoe UI",n.fillText(`Prateleira: ${e.shelf||"-"}`,e.x+8,e.y+34),n.fillText(`Tipo: ${e.type}`,e.x+8,e.y+50),n.restore()}function A(){if(!o.draft)return;const{x:e,y:t,w:s,h:a}=x(o.draft);n.save(),n.fillStyle="rgba(15, 44, 255, 0.12)",n.strokeStyle="#0f2cff",n.setLineDash([8,6]),n.lineWidth=2,n.fillRect(e,t,s,a),n.strokeRect(e,t,s,a),n.restore()}function r(){P(),X();for(const e of o.sections)z(e,e.id===o.selectedId);A()}function u(){h.innerHTML="";for(const e of o.sections){const t=document.createElement("li");t.classList.toggle("active",e.id===o.selectedId);const s=document.createElement("div");s.className="section-meta";const a=document.createElement("span");a.className="section-name",a.textContent=e.name;const l=document.createElement("span");l.className="section-detail",l.textContent=`${e.type} | Prateleira ${e.shelf||"-"}`;const i=document.createElement("span");i.className="swatch",i.style.background=e.color,s.appendChild(a),s.appendChild(l),t.appendChild(s),t.appendChild(i),t.addEventListener("click",()=>{o.selectedId=e.id,u(),r()}),h.appendChild(t)}}function x(e){const t=Math.min(e.startX,e.endX),s=Math.min(e.startY,e.endY),a=Math.abs(e.endX-e.startX),l=Math.abs(e.endY-e.startY);return{x:t,y:s,w:a,h:l}}function S(e){const t=c.getBoundingClientRect(),s=c.width/t.width,a=c.height/t.height;return{x:(e.clientX-t.left)*s,y:(e.clientY-t.top)*a}}function D(e,t){for(let s=o.sections.length-1;s>=0;s-=1){const a=o.sections[s];if(e>=a.x&&e<=a.x+a.w&&t>=a.y&&t<=a.y+a.h)return a}return null}function O(){const e=x(o.draft);if(e.w<m||e.h<m){d("Area muito pequena. Arraste uma area maior.",!0);return}const t=C.value.trim()||`Secao ${o.sections.length+1}`,s=T.value.trim(),a=$.value,l=M.value,i={id:Y(),name:t,shelf:s,type:a,color:l,x:Math.round(e.x),y:Math.round(e.y),w:Math.round(e.w),h:Math.round(e.h)};o.sections.push(i),o.selectedId=i.id,v(),u(),r(),d(`Secao '${t}' criada.`)}c.addEventListener("mousedown",e=>{const t=S(e),s=D(t.x,t.y);if(o.mode==="select"){o.selectedId=s?s.id:null,u(),r();return}if(s){o.selectedId=s.id,u(),r();return}o.draft={startX:t.x,startY:t.y,endX:t.x,endY:t.y}});c.addEventListener("mousemove",e=>{if(!o.draft)return;const t=S(e);o.draft.endX=t.x,o.draft.endY=t.y,r()});c.addEventListener("mouseup",()=>{o.draft&&(O(),o.draft=null,r())});c.addEventListener("mouseleave",()=>{o.draft&&(o.draft=null,r())});E.addEventListener("click",()=>f("draw"));w.addEventListener("click",()=>f("select"));N.addEventListener("click",B);b.addEventListener("click",()=>{o.sections=[],o.selectedId=null,v(),u(),r(),d("Planta limpa.")});R.addEventListener("click",async()=>{if(o.sections.length===0){d("Nada para sincronizar.",!0);return}const e=k();if(!e){d("Sem token de autenticacao.",!0);return}let t=0,s=0;for(const a of o.sections){const l={nome:a.name,pos_x:a.x,pos_y:a.y,largura:a.w,altura:a.h,cor_padrao:a.color};try{(await fetch(`${L}/secoes/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(l)})).ok?t+=1:s+=1}catch{s+=1}}d(`Sincronizacao finalizada. Sucesso: ${t}, Falhas: ${s}.`,s>0)});_();f("draw");u();r();d("Pronto para desenhar a planta.");
